name: OpenAPI Pipeline

on:
  push:
    branches: ["master"]

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    env:
      # GitHub token for committing back
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # Staging Kong URL
      KONG_ADMIN_URL: http://localhost:8001

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3Ô∏è‚É£ Install Node.js dependencies for deck generation
      - name: Install Node.js dependencies
        run: |
          npm install

      # 4Ô∏è‚É£ Install OpenAPI CLI
      - name: Install OpenAPI CLI
        run: npm install -g @redocly/openapi-cli

      # 5Ô∏è‚É£ Lint OpenAPI spec
      - name: Lint OpenAPI
        run: openapi lint openapi.yaml

      # 6Ô∏è‚É£ Install Kong Deck CLI
      - name: Install Kong Deck
        run: |
          curl -Lo deck https://github.com/kong/deck/releases/latest/download/deck_linux_amd64
          chmod +x deck
          sudo mv deck /usr/local/bin/

      # 7Ô∏è‚É£ Generate deck.yaml using Node.js script
      - name: Generate deck.yaml
        run: node generate-deck.js

      # 8Ô∏è‚É£ Validate deck.yaml
      - name: Validate deck.yaml
        run: deck validate -s deck.yaml

      # 9Ô∏è‚É£ Deploy deck.yaml to staging Kong
      - name: Deploy to staging Kong
        run: deck sync -s deck.yaml -t $KONG_ADMIN_URL

      # üîü Commit updated deck.yaml back to GitHub
      - name: Commit updated deck.yaml
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github-actions.com"
          git add deck.yaml
          git commit -m "Update deck.yaml from OpenAPI [skip ci]" || echo "No changes to commit"
          git push origin master

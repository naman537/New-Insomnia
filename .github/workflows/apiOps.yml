name: APIOps Production Pipeline

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    env:
      KONG_ADMIN_URL: ${{ secrets.KONG_ADMIN_URL }}
      KONG_ADMIN_TOKEN: ${{ secrets.KONG_ADMIN_TOKEN }}

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3Ô∏è‚É£ Install Node.js dependencies (local)
      - run: npm ci

      # 4Ô∏è‚É£ Install OpenAPI CLI globally
      - run: npm install -g @redocly/openapi-cli

      # 5Ô∏è‚É£ Lint OpenAPI spec
      - run: openapi lint openapi.yaml

      # 6Ô∏è‚É£ Install Kong Deck CLI
      - run: |
          curl -Lo deck https://github.com/kong/deck/releases/latest/download/deck_linux_amd64
          chmod +x deck
          sudo mv deck /usr/local/bin/

      # 7Ô∏è‚É£ Generate deck.yaml using Node.js script
      - run: node generate-deck.js

      # 8Ô∏è‚É£ Validate deck.yaml
      - run: deck validate -s deck.yaml

      # 9Ô∏è‚É£ Deploy to Kong
      - run: deck sync -s deck.yaml -t $KONG_ADMIN_URL

      # üîü Commit updated deck.yaml back to GitHub
      - run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github-actions.com"
          git add deck.yaml
          git commit -m "Update deck.yaml from OpenAPI [skip ci]" || echo "No changes to commit"
          git push origin main

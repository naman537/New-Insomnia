name: APIOps Production Pipeline

on:
  push:
    branches: ["master"]        # Run when code is pushed to main (production)
  pull_request:
    branches: ["master"]        # Optional: PR validation

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    env:
      # Staging or production Kong URL (set in GitHub secrets)
      KONG_ADMIN_URL: ${{ secrets.KONG_ADMIN_URL }}
      KONG_ADMIN_TOKEN: ${{ secrets.KONG_ADMIN_TOKEN }} # optional if auth required

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3Ô∏è‚É£ Install Node.js dependencies from package-lock.json (production-grade)
      - name: Install Node.js dependencies
        run: npm ci

      # 4Ô∏è‚É£ Install OpenAPI CLI globally
      - name: Install OpenAPI CLI
        run: npm install -g @redocly/openapi-cli

      # 5Ô∏è‚É£ Lint OpenAPI spec
      - name: Lint OpenAPI
        run: openapi lint openapi.yaml

      # 6Ô∏è‚É£ Install Kong Deck CLI
      - name: Install Kong Deck
        run: |
          curl -Lo deck https://github.com/kong/deck/releases/latest/download/deck_linux_amd64
          chmod +x deck
          sudo mv deck /usr/local/bin/

      # 7Ô∏è‚É£ Generate deck.yaml using Node.js script
      - name: Generate deck.yaml
        run: node generate-deck.js

      # 8Ô∏è‚É£ Validate deck.yaml
      - name: Validate deck.yaml
        run: deck validate -s deck.yaml

      # 9Ô∏è‚É£ Deploy deck.yaml to Kong
      - name: Deploy to Kong
        run: deck sync -s deck.yaml -t $KONG_ADMIN_URL

      # üîü Commit updated deck.yaml back to GitHub
      - name: Commit updated deck.yaml
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github-actions.com"
          git add deck.yaml
          git commit -m "Update deck.yaml from OpenAPI [skip ci]" || echo "No changes to commit"
          git push origin main

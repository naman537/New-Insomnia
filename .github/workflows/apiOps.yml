name: APIOps Pipeline

on:
  pull_request:
    branches: ["master"]
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:
  apiops:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2️⃣ Lint OpenAPI (PR + main)
      - name: Lint OpenAPI spec
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            kong/inso:latest \
            lint spec /workspace/openapi/openapi.yaml

      # 3️⃣ Generate Kong config (PR + main)
      - name: Generate Kong config
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            kong/deck:latest \
            file openapi2kong \
              --spec /workspace/openapi/openapi.yaml \
              --output-file /workspace/kong/kong.yaml

      # 4️⃣ Deploy ONLY on master branch push
      - name: Deploy to Kong
        if: github.event_name == 'push'
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            kong/deck:latest \
            sync \
              --state /workspace/kong/kong.yaml \
              --kong-addr http://localhost:8001

name: APIOps Pipeline

on:
  push:
    branches: ["master"]

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      KONG_ADMIN_URL: http://localhost:8001

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3️⃣ Install OpenAPI CLI
      - name: Install OpenAPI CLI
        run: npm install -g @redocly/openapi-cli

      # 4️⃣ Lint OpenAPI
      - name: Lint OpenAPI
        run: openapi lint openapi.yaml

      # 5️⃣ Install Kong Deck CLI
      - name: Install Kong Deck
        run: |
          curl -Lo deck https://github.com/kong/deck/releases/latest/download/deck_linux_amd64
          chmod +x deck
          sudo mv deck /usr/local/bin/

      # 6️⃣ Generate deck.yaml using Node.js
      - name: Generate deck.yaml
        run: |
          echo "Generating deck.yaml from OpenAPI..."
          node generate-deck.js

      # 7️⃣ Validate deck.yaml
      - name: Validate deck.yaml
        run: deck validate -s deck.yaml

      # 8️⃣ Deploy to staging Kong
      - name: Deploy to staging Kong
        run: deck sync -s deck.yaml -t $KONG_ADMIN_URL

      # 9️⃣ Commit updated deck.yaml back to GitHub
      - name: Commit updated deck.yaml
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github-actions.com"
          git add deck.yaml
          git commit -m "Update deck.yaml from OpenAPI [skip ci]" || echo "No changes to commit"
          git push origin master
